<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Timer + Stopwatch + World Clock</title>
  <style>
    :root{
      --bg:#f6fbff;
      --card:#ffffff;
      --ink:#0b1f2a;
      --muted:#4a6b7a;
      --line:#d7e9f6;
      --blue:#1e88e5;
      --blue2:#0d65c2;
      --pill:#e9f4ff;
      --shadow: 0 8px 26px rgba(12, 49, 74, .08);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body.dark{
      --bg:#071824;
      --card:#0b2232;
      --ink:#e8f4ff;
      --muted:#a7c0cf;
      --line:#13364b;
      --pill:#0f2b3f;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--ink);
    }

    .wrap{
      max-width:1100px;
      margin:22px auto;
      padding:0 14px 24px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:14px;
      align-items:start;
    }

    /* Left-anchored rail */
    .rail{
      position:sticky;
      top:14px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:6px 8px 10px;
      border-bottom:1px solid var(--line);
      margin-bottom:10px;
    }
    .brand h1{font-size:14px; margin:0; letter-spacing:.2px}
    .brand .sub{font-size:12px; color:var(--muted)}
    .toggleRow{display:flex; gap:8px; align-items:center}

    .btn{
      border:1px solid var(--line);
      background:var(--pill);
      color:var(--ink);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(180deg, var(--blue), var(--blue2));
      border-color:transparent;
      color:white;
    }
    .btn.ghost{
      background:transparent;
      border-color:var(--line);
    }
    .btn.small{padding:7px 10px; border-radius:10px; font-size:12px}
    .btn.danger{background:#ffecec;border-color:#ffd1d1;color:#8b1c1c}
    body.dark .btn.danger{background:#3a1515;border-color:#5b1f1f;color:#ffd7d7}

    .nav{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .nav button{
      width:100%;
      text-align:left;
      display:flex; align-items:center; justify-content:space-between;
      background:transparent;
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      color:var(--ink);
    }
    .nav button.active{
      border-color:rgba(30,136,229,.55);
      box-shadow:0 0 0 3px rgba(30,136,229,.14);
      background:rgba(30,136,229,.06);
    }
    .nav .hint{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.35}

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .cardHead{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      margin-bottom:10px;
      padding-bottom:10px;
      border-bottom:1px solid var(--line);
    }
    .cardHead h2{margin:0; font-size:16px}
    .cardHead .meta{font-size:12px; color:var(--muted)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 940px){
      .wrap{grid-template-columns:1fr}
      .rail{position:relative; top:auto}
      .grid2{grid-template-columns:1fr}
    }

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row.space{justify-content:space-between}
    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width:120px;
    }
    label{font-size:12px; color:var(--muted)}
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:transparent;
      color:var(--ink);
      outline:none;
    }
    input:focus, select:focus{
      border-color:rgba(30,136,229,.55);
      box-shadow:0 0 0 3px rgba(30,136,229,.14);
    }

    .bigTime{
      font-family:var(--mono);
      font-size:46px;
      letter-spacing:.5px;
      margin:8px 0 10px;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      background:var(--pill);
      border:1px solid var(--line);
      padding:7px 10px;
      border-radius:999px;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    .list{
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(0,0,0,0.0);
    }
    .item .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .item .title{
      font-weight:750;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:520px;
    }
    .item .sub{
      color:var(--muted);
      font-size:12px;
      font-family:var(--mono);
    }
    .sep{height:1px;background:var(--line);margin:12px 0}

    .laps{
      max-height:240px;
      overflow:auto;
      padding-right:4px;
    }
    .laps .lap{
      display:flex; justify-content:space-between; gap:10px;
      font-family:var(--mono);
      font-size:13px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(30,136,229,.04);
      margin-bottom:8px;
    }
    .mono{font-family:var(--mono)}
    .kbd{
      font-family:var(--mono);
      font-size:12px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--line);
      background:var(--pill);
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="rail">
      <div class="brand">
        <div>
          <h1>Clock Tools</h1>
          <div class="sub">Timer ‚Ä¢ Stopwatch ‚Ä¢ World Clock</div>
        </div>
        <div class="toggleRow">
          <button class="btn small ghost" id="themeBtn" title="Toggle theme">‚òº/‚òæ</button>
        </div>
      </div>

      <div class="nav" role="tablist" aria-label="Tools">
        <button id="tabTimer" class="active" data-target="panelTimer">
          <span>‚è≥ Timer</span><span class="kbd">1</span>
        </button>
        <button id="tabStopwatch" data-target="panelStopwatch">
          <span>‚è±Ô∏è Stopwatch</span><span class="kbd">2</span>
        </button>
        <button id="tabWorld" data-target="panelWorld">
          <span>üåç World Clock</span><span class="kbd">3</span>
        </button>

        <div class="hint">
          Shortcuts: <span class="kbd">1</span> <span class="kbd">2</span> <span class="kbd">3</span> switch tools.
          Timer: <span class="kbd">Space</span> start/pause, <span class="kbd">R</span> reset.
        </div>
      </div>
    </aside>

    <main class="main">
      <!-- TIMER -->
      <section id="panelTimer" class="card">
        <div class="cardHead">
          <div>
            <h2>Timer</h2>
            <div class="meta">Countdown with start/pause, add time, and a clean ‚Äúdone‚Äù state.</div>
          </div>
          <div class="row">
            <span class="pill" id="timerStatePill">Ready</span>
          </div>
        </div>

        <div class="grid2">
          <div>
            <div class="row">
              <div class="field" style="max-width:110px">
                <label for="tHours">Hours</label>
                <input id="tHours" inputmode="numeric" type="number" min="0" max="99" value="0">
              </div>
              <div class="field" style="max-width:110px">
                <label for="tMinutes">Minutes</label>
                <input id="tMinutes" inputmode="numeric" type="number" min="0" max="59" value="5">
              </div>
              <div class="field" style="max-width:110px">
                <label for="tSeconds">Seconds</label>
                <input id="tSeconds" inputmode="numeric" type="number" min="0" max="59" value="0">
              </div>
            </div>

            <div class="bigTime" id="timerDisplay">00:05:00</div>

            <div class="row">
              <button class="btn primary" id="timerStartBtn">Start</button>
              <button class="btn" id="timerPauseBtn" disabled>Pause</button>
              <button class="btn" id="timerResetBtn">Reset</button>
              <button class="btn" id="timerPlus10Btn">+10s</button>
              <button class="btn" id="timerPlus1Btn">+1m</button>
            </div>

            <div class="sep"></div>

            <div class="row">
              <span class="pill">Presets</span>
              <button class="btn small" data-preset="0,1,0">1:00</button>
              <button class="btn small" data-preset="0,3,0">3:00</button>
              <button class="btn small" data-preset="0,5,0">5:00</button>
              <button class="btn small" data-preset="0,10,0">10:00</button>
              <button class="btn small" data-preset="0,20,0">20:00</button>
            </div>
          </div>

          <div>
            <div class="row space">
              <div class="pill">End alert</div>
              <div class="row">
                <label class="pill" style="cursor:pointer">
                  <input id="beepToggle" type="checkbox" style="width:auto; margin:0 8px 0 0">
                  Beep
                </label>
                <label class="pill" style="cursor:pointer">
                  <input id="vibrateToggle" type="checkbox" style="width:auto; margin:0 8px 0 0">
                  Vibrate
                </label>
              </div>
            </div>

            <div class="sep"></div>

            <div class="row">
              <div class="field" style="min-width:240px">
                <label>Notes</label>
                <input id="timerNote" placeholder="e.g., Stretch, meditate, cold shower">
              </div>
            </div>

            <div class="sep"></div>

            <div class="pill mono">
              Remaining ms: <span id="timerMs">0</span>
            </div>
          </div>
        </div>
      </section>

      <!-- STOPWATCH -->
      <section id="panelStopwatch" class="card" style="display:none">
        <div class="cardHead">
          <div>
            <h2>Stopwatch</h2>
            <div class="meta">Start/pause, lap capture, and a scrollable lap list.</div>
          </div>
          <div class="row">
            <span class="pill" id="swStatePill">Stopped</span>
          </div>
        </div>

        <div class="grid2">
          <div>
            <div class="bigTime" id="swDisplay">00:00.00</div>
            <div class="row">
              <button class="btn primary" id="swStartBtn">Start</button>
              <button class="btn" id="swPauseBtn" disabled>Pause</button>
              <button class="btn" id="swLapBtn" disabled>Lap</button>
              <button class="btn" id="swResetBtn">Reset</button>
            </div>
            <div class="sep"></div>
            <div class="pill mono">
              Total ms: <span id="swMs">0</span>
            </div>
          </div>

          <div>
            <div class="row space">
              <span class="pill">Laps</span>
              <button class="btn small danger" id="swClearLapsBtn" disabled>Clear</button>
            </div>
            <div class="sep"></div>
            <div class="laps" id="lapsBox"></div>
          </div>
        </div>
      </section>

      <!-- WORLD CLOCK -->
      <section id="panelWorld" class="card" style="display:none">
        <div class="cardHead">
          <div>
            <h2>World Clock</h2>
            <div class="meta">Add cities, reorder, remove ‚Äî optional 24-hour time.</div>
          </div>
          <div class="row">
            <label class="pill" style="cursor:pointer">
              <input id="twentyFourToggle" type="checkbox" style="width:auto; margin:0 8px 0 0">
              24-hour time
            </label>
          </div>
        </div>

        <div class="row">
          <div class="field" style="min-width:240px">
            <label for="cityLabel">Label</label>
            <input id="cityLabel" placeholder="e.g., London">
          </div>

          <div class="field" style="min-width:320px; flex:1">
            <label for="tzSelect">Time zone</label>
            <select id="tzSelect"></select>
          </div>

          <div class="field" style="min-width:160px">
            <label>&nbsp;</label>
            <button class="btn primary" id="addCityBtn">Add</button>
          </div>
        </div>

        <div class="sep"></div>

        <ul class="list" id="worldList"></ul>

        <div class="sep"></div>
        <div class="row">
          <button class="btn" id="addNYBtn">Add New York</button>
          <button class="btn" id="addLondonBtn">Add London</button>
          <button class="btn" id="addTokyoBtn">Add Tokyo</button>
          <button class="btn danger" id="clearWorldBtn">Clear all</button>
        </div>
      </section>
    </main>
  </div>

<script>
(() => {
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,'0');

  const store = {
    get(key, fallback){
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
      catch { return fallback; }
    },
    set(key, val){
      localStorage.setItem(key, JSON.stringify(val));
    }
  };

  // ---------- Theme ----------
  const themeBtn = $('themeBtn');
  const savedTheme = store.get('clocktools.theme', 'light');
  if(savedTheme === 'dark') document.body.classList.add('dark');
  themeBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    store.set('clocktools.theme', document.body.classList.contains('dark') ? 'dark' : 'light');
  });

  // ---------- Tabs ----------
  const tabs = [
    { btn:'tabTimer', panel:'panelTimer' },
    { btn:'tabStopwatch', panel:'panelStopwatch' },
    { btn:'tabWorld', panel:'panelWorld' },
  ];
  function showPanel(panelId){
    for(const t of tabs){
      $(t.panel).style.display = (t.panel === panelId) ? '' : 'none';
      $(t.btn).classList.toggle('active', t.panel === panelId);
    }
    store.set('clocktools.activePanel', panelId);
  }
  tabs.forEach(t => $(t.btn).addEventListener('click', () => showPanel(t.panel)));
  showPanel(store.get('clocktools.activePanel', 'panelTimer'));

  // keyboard shortcuts: 1/2/3
  window.addEventListener('keydown', (e) => {
    if(e.target && ['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) return;
    if(e.key === '1') showPanel('panelTimer');
    if(e.key === '2') showPanel('panelStopwatch');
    if(e.key === '3') showPanel('panelWorld');
  });

  // ---------- TIMER ----------
  let timerInterval = null;
  let remainingMs = 0;
  let timerRunning = false;

  const tHours = $('tHours'), tMinutes = $('tMinutes'), tSeconds = $('tSeconds');
  const timerDisplay = $('timerDisplay');
  const timerMs = $('timerMs');
  const timerStatePill = $('timerStatePill');
  const timerStartBtn = $('timerStartBtn');
  const timerPauseBtn = $('timerPauseBtn');
  const timerResetBtn = $('timerResetBtn');
  const timerPlus10Btn = $('timerPlus10Btn');
  const timerPlus1Btn = $('timerPlus1Btn');
  const beepToggle = $('beepToggle');
  const vibrateToggle = $('vibrateToggle');
  const timerNote = $('timerNote');

  const savedTimer = store.get('clocktools.timer', {
    h:0, m:5, s:0, beep:true, vibrate:false, note:''
  });
  tHours.value = savedTimer.h;
  tMinutes.value = savedTimer.m;
  tSeconds.value = savedTimer.s;
  beepToggle.checked = !!savedTimer.beep;
  vibrateToggle.checked = !!savedTimer.vibrate;
  timerNote.value = savedTimer.note || '';

  function saveTimerInputs(){
    store.set('clocktools.timer', {
      h: clampInt(tHours.value, 0, 99),
      m: clampInt(tMinutes.value, 0, 59),
      s: clampInt(tSeconds.value, 0, 59),
      beep: beepToggle.checked,
      vibrate: vibrateToggle.checked,
      note: timerNote.value || ''
    });
  }

  function clampInt(v, min, max){
    const n = Math.floor(Number(v) || 0);
    return Math.max(min, Math.min(max, n));
  }

  function inputsToMs(){
    const h = clampInt(tHours.value, 0, 99);
    const m = clampInt(tMinutes.value, 0, 59);
    const s = clampInt(tSeconds.value, 0, 59);
    return ((h*3600) + (m*60) + s) * 1000;
  }

  function msToHMS(ms){
    const totalSec = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(totalSec/3600);
    const m = Math.floor((totalSec%3600)/60);
    const s = totalSec%60;
    return {h,m,s};
  }

  function formatHMS(ms){
    const {h,m,s} = msToHMS(ms);
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  }

  function renderTimer(){
    timerDisplay.textContent = formatHMS(remainingMs);
    timerMs.textContent = String(remainingMs);
  }

  function setTimerState(label){
    timerStatePill.textContent = label;
  }

  function enableTimerButtons(){
    timerStartBtn.disabled = timerRunning || remainingMs <= 0;
    timerPauseBtn.disabled = !timerRunning;
  }

  function stopTimerInterval(){
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    timerRunning = false;
    enableTimerButtons();
  }

  function beep(){
    // simple WebAudio beep; requires user gesture first (Start button counts)
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.value = 880;
      g.gain.value = 0.06;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(() => { o.stop(); ctx.close(); }, 220);
    }catch(_){}
  }

  function notifyDone(){
    setTimerState('Done');
    if(beepToggle.checked) beep();
    if(vibrateToggle.checked && navigator.vibrate) navigator.vibrate([160, 80, 160]);
    // subtle title flash
    const orig = document.title;
    document.title = '‚è≥ Timer done';
    setTimeout(() => document.title = orig, 1400);
  }

  function startTimer(){
    if(timerRunning) return;
    if(remainingMs <= 0) return;
    setTimerState('Running');
    timerRunning = true;
    enableTimerButtons();

    const tick = () => {
      remainingMs -= 100;
      if(remainingMs <= 0){
        remainingMs = 0;
        renderTimer();
        stopTimerInterval();
        notifyDone();
        return;
      }
      renderTimer();
    };

    timerInterval = setInterval(tick, 100);
  }

  function pauseTimer(){
    if(!timerRunning) return;
    setTimerState('Paused');
    stopTimerInterval();
  }

  function resetTimer(){
    stopTimerInterval();
    setTimerState('Ready');
    remainingMs = inputsToMs();
    renderTimer();
    enableTimerButtons();
  }

  function syncInputsFromMs(){
    const {h,m,s} = msToHMS(remainingMs);
    tHours.value = h;
    tMinutes.value = m;
    tSeconds.value = s;
  }

  function bumpTimer(deltaMs){
    remainingMs = Math.max(0, remainingMs + deltaMs);
    renderTimer();
    enableTimerButtons();
    syncInputsFromMs();
    saveTimerInputs();
  }

  // Init remainingMs from inputs
  remainingMs = inputsToMs();
  renderTimer();
  enableTimerButtons();

  [tHours,tMinutes,tSeconds].forEach(el => el.addEventListener('change', () => {
    saveTimerInputs();
    if(!timerRunning){
      remainingMs = inputsToMs();
      renderTimer();
      enableTimerButtons();
      setTimerState(remainingMs>0 ? 'Ready' : 'Set a time');
    }
  }));
  [beepToggle, vibrateToggle, timerNote].forEach(el => el.addEventListener('change', saveTimerInputs));

  timerStartBtn.addEventListener('click', () => {
    // if remaining is 0, re-read inputs
    if(remainingMs <= 0){
      remainingMs = inputsToMs();
      renderTimer();
    }
    startTimer();
  });
  timerPauseBtn.addEventListener('click', pauseTimer);
  timerResetBtn.addEventListener('click', () => { resetTimer(); saveTimerInputs(); });
  timerPlus10Btn.addEventListener('click', () => bumpTimer(10_000));
  timerPlus1Btn.addEventListener('click', () => bumpTimer(60_000));

  document.querySelectorAll('[data-preset]').forEach(btn => {
    btn.addEventListener('click', () => {
      const [h,m,s] = btn.getAttribute('data-preset').split(',').map(Number);
      tHours.value = h; tMinutes.value = m; tSeconds.value = s;
      saveTimerInputs();
      stopTimerInterval();
      setTimerState('Ready');
      remainingMs = inputsToMs();
      renderTimer();
      enableTimerButtons();
    });
  });

  // Timer keyboard shortcuts (when timer panel visible)
  window.addEventListener('keydown', (e) => {
    const timerVisible = $('panelTimer').style.display !== 'none';
    if(!timerVisible) return;
    if(e.target && ['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) return;

    if(e.code === 'Space'){
      e.preventDefault();
      if(timerRunning) pauseTimer();
      else startTimer();
    }
    if(e.key.toLowerCase() === 'r'){
      resetTimer();
      saveTimerInputs();
    }
  });

  // ---------- STOPWATCH ----------
  let swInterval = null;
  let swRunning = false;
  let swStartTs = 0;
  let swElapsedMs = 0;
  let laps = [];

  const swDisplay = $('swDisplay');
  const swMs = $('swMs');
  const swStatePill = $('swStatePill');
  const swStartBtn = $('swStartBtn');
  const swPauseBtn = $('swPauseBtn');
  const swLapBtn = $('swLapBtn');
  const swResetBtn = $('swResetBtn');
  const swClearLapsBtn = $('swClearLapsBtn');
  const lapsBox = $('lapsBox');

  function formatStopwatch(ms){
    const total = Math.max(0, ms);
    const min = Math.floor(total/60000);
    const sec = Math.floor((total%60000)/1000);
    const cs  = Math.floor((total%1000)/10); // centiseconds
    return `${pad2(min)}:${pad2(sec)}.${pad2(cs)}`;
  }

  function renderStopwatch(){
    swDisplay.textContent = formatStopwatch(swElapsedMs);
    swMs.textContent = String(swElapsedMs);
  }

  function setSwState(t){ swStatePill.textContent = t; }

  function renderLaps(){
    lapsBox.innerHTML = '';
    laps.forEach((lap, i) => {
      const div = document.createElement('div');
      div.className = 'lap';
      div.innerHTML = `<span>Lap ${laps.length - i}</span><span>${formatStopwatch(lap)}</span>`;
      lapsBox.appendChild(div);
    });
    swClearLapsBtn.disabled = laps.length === 0;
  }

  function startStopwatch(){
    if(swRunning) return;
    swRunning = true;
    setSwState('Running');
    swStartTs = performance.now() - swElapsedMs;

    swStartBtn.disabled = true;
    swPauseBtn.disabled = false;
    swLapBtn.disabled = false;

    swInterval = setInterval(() => {
      swElapsedMs = Math.floor(performance.now() - swStartTs);
      renderStopwatch();
    }, 31);
  }

  function pauseStopwatch(){
    if(!swRunning) return;
    swRunning = false;
    setSwState('Paused');
    clearInterval(swInterval);
    swInterval = null;

    swStartBtn.disabled = false;
    swPauseBtn.disabled = true;
    swLapBtn.disabled = true;
  }

  function resetStopwatch(){
    pauseStopwatch();
    setSwState('Stopped');
    swElapsedMs = 0;
    laps = [];
    renderStopwatch();
    renderLaps();

    swStartBtn.disabled = false;
    swPauseBtn.disabled = true;
    swLapBtn.disabled = true;
  }

  function lapStopwatch(){
    if(!swRunning) return;
    laps.unshift(swElapsedMs);
    renderLaps();
  }

  swStartBtn.addEventListener('click', startStopwatch);
  swPauseBtn.addEventListener('click', pauseStopwatch);
  swResetBtn.addEventListener('click', resetStopwatch);
  swLapBtn.addEventListener('click', lapStopwatch);
  swClearLapsBtn.addEventListener('click', () => { laps = []; renderLaps(); });

  renderStopwatch();
  renderLaps();

  // ---------- WORLD CLOCK ----------
  const tzSelect = $('tzSelect');
  const cityLabel = $('cityLabel');
  const addCityBtn = $('addCityBtn');
  const worldList = $('worldList');
  const twentyFourToggle = $('twentyFourToggle');
  const addNYBtn = $('addNYBtn');
  const addLondonBtn = $('addLondonBtn');
  const addTokyoBtn = $('addTokyoBtn');
  const clearWorldBtn = $('clearWorldBtn');

  // Fill timezone list (best effort)
  const tzList = (() => {
    if(Intl && Intl.supportedValuesOf){
      try { return Intl.supportedValuesOf('timeZone'); } catch(e){ /* ignore */ }
    }
    // fallback minimal set
    return [
      'America/New_York','America/Chicago','America/Denver','America/Los_Angeles',
      'Europe/London','Europe/Paris','Europe/Berlin',
      'Asia/Tokyo','Asia/Shanghai','Asia/Kolkata',
      'Australia/Sydney','Pacific/Auckland'
    ];
  })();

  tzList.forEach(tz => {
    const opt = document.createElement('option');
    opt.value = tz;
    opt.textContent = tz;
    tzSelect.appendChild(opt);
  });

  const savedWorld = store.get('clocktools.world', {
    use24h: false,
    cities: [
      {label:'New York', tz:'America/New_York'},
      {label:'London', tz:'Europe/London'},
      {label:'Tokyo', tz:'Asia/Tokyo'}
    ]
  });

  twentyFourToggle.checked = !!savedWorld.use24h;
  let cities = Array.isArray(savedWorld.cities) ? savedWorld.cities : [];

  function saveWorld(){
    store.set('clocktools.world', { use24h: twentyFourToggle.checked, cities });
  }

  function fmtTime(tz){
    const opts = {
      timeZone: tz,
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: !twentyFourToggle.checked
    };
    return new Intl.DateTimeFormat(undefined, opts).format(new Date());
  }

  function fmtDate(tz){
    const opts = {
      timeZone: tz,
      weekday: 'short',
      year: 'numeric',
      month: 'short',
      day: '2-digit',
    };
    return new Intl.DateTimeFormat(undefined, opts).format(new Date());
  }

  function renderWorld(){
    worldList.innerHTML = '';
    cities.forEach((c, idx) => {
      const li = document.createElement('li');
      li.className = 'item';

      const left = document.createElement('div');
      left.className = 'left';

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = c.label || c.tz;

      const sub = document.createElement('div');
      sub.className = 'sub';
      sub.textContent = `${fmtDate(c.tz)} ‚Ä¢ ${c.tz}`;

      left.appendChild(title);
      left.appendChild(sub);

      const right = document.createElement('div');
      right.style.display='flex';
      right.style.alignItems='center';
      right.style.gap='8px';

      const time = document.createElement('div');
      time.className = 'mono';
      time.style.fontSize='18px';
      time.style.fontWeight='800';
      time.textContent = fmtTime(c.tz);

      const up = document.createElement('button');
      up.className = 'btn small';
      up.textContent = '‚Üë';
      up.disabled = idx === 0;
      up.addEventListener('click', () => {
        if(idx === 0) return;
        const tmp = cities[idx-1];
        cities[idx-1] = cities[idx];
        cities[idx] = tmp;
        saveWorld();
        renderWorld();
      });

      const down = document.createElement('button');
      down.className = 'btn small';
      down.textContent = '‚Üì';
      down.disabled = idx === cities.length - 1;
      down.addEventListener('click', () => {
        if(idx === cities.length - 1) return;
        const tmp = cities[idx+1];
        cities[idx+1] = cities[idx];
        cities[idx] = tmp;
        saveWorld();
        renderWorld();
      });

      const del = document.createElement('button');
      del.className = 'btn small danger';
      del.textContent = 'Remove';
      del.addEventListener('click', () => {
        cities.splice(idx, 1);
        saveWorld();
        renderWorld();
      });

      right.appendChild(time);
      right.appendChild(up);
      right.appendChild(down);
      right.appendChild(del);

      li.appendChild(left);
      li.appendChild(right);
      worldList.appendChild(li);
    });
  }

  function addCity(label, tz){
    if(!tz) return;
    cities.push({label: label || tz, tz});
    saveWorld();
    renderWorld();
    cityLabel.value = '';
  }

  // Default select to user's local TZ if available
  const localTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
  if(tzList.includes(localTZ)) tzSelect.value = localTZ;
  else tzSelect.value = tzList[0];

  addCityBtn.addEventListener('click', () => addCity(cityLabel.value.trim(), tzSelect.value));
  cityLabel.addEventListener('keydown', (e) => { if(e.key === 'Enter') addCityBtn.click(); });
  twentyFourToggle.addEventListener('change', () => { saveWorld(); renderWorld(); });

  addNYBtn.addEventListener('click', () => addCity('New York', 'America/New_York'));
  addLondonBtn.addEventListener('click', () => addCity('London', 'Europe/London'));
  addTokyoBtn.addEventListener('click', () => addCity('Tokyo', 'Asia/Tokyo'));

  clearWorldBtn.addEventListener('click', () => {
    cities = [];
    saveWorld();
    renderWorld();
  });

  renderWorld();
  saveWorld();

  // Live ticking for world clock
  setInterval(() => {
    const worldVisible = $('panelWorld').style.display !== 'none';
    if(worldVisible) renderWorld();
  }, 1000);

})();
</script>
</body>
</html>
